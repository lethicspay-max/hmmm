# Firebase Database Structure

## Collections Overview

This document describes the Firebase Firestore collections used for managing corporate product customization and access control.

---

## 1. `corporateProductSettings` Collection

**Purpose**: Stores individual product-level settings for each corporate, including custom pricing and lock status.

### Document Structure

**Document ID Format**: `${corporateId}_${productId}`
- Example: `abc123_product456`
- This compound key ensures one setting document per corporate-product pair

**Fields**:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `corporateId` | string | Yes | Reference to the corporate user's document ID |
| `productId` | string | Yes | Reference to the product document ID |
| `customPrice` | number \| null | No | Custom point cost for this product. `null` means use default price |
| `isLocked` | boolean | Yes | If `true`, product is hidden from corporate's product selection |
| `selectedByCorporate` | boolean | No | If corporate has selected this product (for their catalog) |
| `createdAt` | Timestamp | Yes | When this setting was first created |
| `updatedAt` | Timestamp | Yes | When this setting was last modified |

### Example Document

```json
{
  "corporateId": "corp_abc123",
  "productId": "prod_xyz789",
  "customPrice": 150,
  "isLocked": false,
  "selectedByCorporate": true,
  "createdAt": Timestamp(2024-01-15T10:30:00Z),
  "updatedAt": Timestamp(2024-01-20T14:45:00Z)
}
```

### Query Patterns

**Get all settings for a corporate:**
```javascript
const settingsQuery = query(
  collection(db, 'corporateProductSettings'),
  where('corporateId', '==', corporateId)
);
```

**Get settings for specific product across all corporates:**
```javascript
const settingsQuery = query(
  collection(db, 'corporateProductSettings'),
  where('productId', '==', productId)
);
```

**Get specific corporate-product setting:**
```javascript
const docRef = doc(db, 'corporateProductSettings', `${corporateId}_${productId}`);
```

### Business Rules

1. **Product Visibility**: If `isLocked = true`, the product will NOT appear in the corporate's product selection list
2. **Pricing Hierarchy**:
   - If `customPrice` is set (not null), use custom price
   - If `customPrice` is null, use default product price
3. **Auto-creation**: Settings are only created when admin modifies them (no default documents)

---

## 2. `corporateSettings` Collection

**Purpose**: Stores general settings and feature flags for each corporate account.

### Document Structure

**Document ID**: Auto-generated by Firestore
- Each corporate has ONE document in this collection
- Query by `corporateId` field to find the document

**Fields**:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `corporateId` | string | Yes | Reference to the corporate user's document ID |
| `productSelectionLocked` | boolean | Yes | If `true`, entire Products tab is hidden from corporate dashboard |
| `createdAt` | string | Yes | ISO 8601 timestamp when settings were created |
| `updatedAt` | string | Yes | ISO 8601 timestamp when settings were last modified |

### Example Document

```json
{
  "corporateId": "corp_abc123",
  "productSelectionLocked": true,
  "createdAt": "2024-01-15T10:30:00.000Z",
  "updatedAt": "2024-01-20T14:45:00.000Z"
}
```

### Query Patterns

**Get settings for a corporate:**
```javascript
const settingsQuery = query(
  collection(db, 'corporateSettings'),
  where('corporateId', '==', corporateId)
);
const snapshot = await getDocs(settingsQuery);
const settings = snapshot.empty ? null : snapshot.docs[0].data();
```

### Business Rules

1. **Feature Lock**: If `productSelectionLocked = true`, corporate cannot access the Products tab at all
2. **Priority**: This setting overrides individual product locks (if tab is locked, product locks don't matter)
3. **Default Behavior**: If no document exists for a corporate, all features are unlocked by default

---

## 3. Access Control Hierarchy

The system implements a three-level access control hierarchy:

### Level 1: Tab-Level Lock (Highest Priority)
- **Collection**: `corporateSettings`
- **Field**: `productSelectionLocked`
- **Effect**: Hides entire Products tab
- **Use Case**: Completely disable product selection feature for a corporate

### Level 2: Product-Level Lock (Medium Priority)
- **Collection**: `corporateProductSettings`
- **Field**: `isLocked`
- **Effect**: Hides specific products from product list
- **Use Case**: Restrict access to certain products while allowing others

### Level 3: Custom Pricing (Lowest Priority)
- **Collection**: `corporateProductSettings`
- **Field**: `customPrice`
- **Effect**: Changes point cost for specific products
- **Use Case**: Offer special pricing to specific corporates

---

## 4. Related Collections

These collections are referenced by the product customization system:

### `users` Collection (Corporate Users)
- Stores corporate account information
- Fields used: `role`, `status`, `companyName`, `contactName`, `email`
- Query: `where('role', '==', 'corporate')`

### `products` Collection
- Stores product catalog
- Fields used: `name`, `sku`, `pointCost`, `category`, `imageUrl`, `status`
- Query: `where('status', '==', 'active')`

---

## 5. Data Flow

### Admin Side (Setting Locks/Prices)

1. Admin selects a corporate from dropdown
2. System loads all settings for that corporate:
   ```javascript
   // Load product settings
   const settingsSnapshot = await getDocs(collection(db, 'corporateProductSettings'));

   // Load general settings
   const corporateSettingsQuery = query(
     collection(db, 'corporateSettings'),
     where('corporateId', '==', selectedCorporate)
   );
   ```
3. Admin modifies prices and lock statuses
4. On save, system updates/creates documents:
   ```javascript
   // Save product settings
   const docId = `${corporateId}_${productId}`;
   await setDoc(doc(db, 'corporateProductSettings', docId), {
     corporateId,
     productId,
     customPrice,
     isLocked,
     updatedAt: Timestamp.now(),
     createdAt: Timestamp.now()
   }, { merge: true });

   // Save general settings
   await updateDoc(corporateSettingsDoc, {
     productSelectionLocked,
     updatedAt: new Date().toISOString()
   });
   ```

### Corporate Side (Viewing Products)

1. Corporate logs in to dashboard
2. System checks if Products tab should be visible:
   ```javascript
   const settingsQuery = query(
     collection(db, 'corporateSettings'),
     where('corporateId', '==', currentUser.uid)
   );
   const settings = await getDocs(settingsQuery);
   const isTabLocked = settings.productSelectionLocked || false;
   ```
3. If tab is visible, system loads products and filters locked ones:
   ```javascript
   const settingsSnapshot = await getDocs(collection(db, 'corporateProductSettings'));
   const lockedProducts = settingsSnapshot.docs
     .filter(doc => doc.data().corporateId === currentUser.uid && doc.data().isLocked)
     .map(doc => doc.data().productId);

   const visibleProducts = allProducts.filter(p => !lockedProducts.includes(p.id));
   ```

---

## 6. Security Considerations

### Firestore Security Rules (Recommended)

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Corporate Product Settings - Admin only write, corporate read their own
    match /corporateProductSettings/{settingId} {
      allow read: if request.auth != null &&
        (request.auth.token.role == 'admin' ||
         resource.data.corporateId == request.auth.uid);
      allow write: if request.auth != null &&
        request.auth.token.role == 'admin';
    }

    // Corporate Settings - Admin only write, corporate read their own
    match /corporateSettings/{settingId} {
      allow read: if request.auth != null &&
        (request.auth.token.role == 'admin' ||
         resource.data.corporateId == request.auth.uid);
      allow write: if request.auth != null &&
        request.auth.token.role == 'admin';
    }
  }
}
```

---

## 7. Performance Optimization

### Current Implementation
- Uses client-side filtering by loading all documents
- Simple but not optimal for large datasets

### Recommended Improvements for Scale

1. **Add Composite Indexes**:
   - Create index on `corporateProductSettings`: `corporateId` + `isLocked`
   - Create index on `corporateProductSettings`: `corporateId` + `productId`

2. **Use Targeted Queries**:
   ```javascript
   // Instead of loading all and filtering
   const unlockedQuery = query(
     collection(db, 'corporateProductSettings'),
     where('corporateId', '==', currentUser.uid),
     where('isLocked', '==', false)
   );
   ```

3. **Consider Denormalization**:
   - Store locked product IDs array in corporate's user document
   - Trade: Faster reads, but must keep in sync

---

## 8. Migration Guide

If you need to add this structure to an existing database:

```javascript
// Create initial settings for existing corporates
async function initializeCorporateSettings() {
  const corporatesQuery = query(
    collection(db, 'users'),
    where('role', '==', 'corporate')
  );
  const snapshot = await getDocs(corporatesQuery);

  for (const doc of snapshot.docs) {
    await addDoc(collection(db, 'corporateSettings'), {
      corporateId: doc.id,
      productSelectionLocked: false,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    });
  }
}
```

---

## Summary

The Firebase structure provides flexible, granular control over product visibility and pricing for each corporate:

- **Two-Collection Design**: Separates general settings from product-specific settings
- **Compound Keys**: Uses `corporateId_productId` for efficient product setting lookups
- **Hierarchical Control**: Tab lock → Product lock → Custom pricing
- **Scalable**: Can be optimized with indexes and targeted queries as data grows
